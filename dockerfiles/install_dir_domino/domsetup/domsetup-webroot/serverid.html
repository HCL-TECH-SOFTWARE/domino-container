<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="assets/bootstrap.min.css">
    <title>HCL Domino Server Configuration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #dropZone {
            width: 350px;
            height: 120px;
            border: 2px dashed #007BFF;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            margin: 20px auto;
            padding: 10px;
            cursor: pointer;
            color: #007BFF;
        }
        #dropZone.highlight {
            background-color: #f0f8ff;
        }
    </style>
</head>
<body>

    <br>
    <br>
    <img src="assets/domsetup-logo.svg" style="max-height: 100px;" class="" alt="HCL Domino Server">
    <br>
    <br>
    <h3>Server.ID Upload</h3>
    <br>

    <!-- Drag-and-Drop Zone -->
    <div id="dropZone">Drag & drop a file or click to select</div>
    <br>
    <p>Upload Domino server.id file for additional server setup.</p>
    <p><b>server.id</b> is uploaded to data directory and must match OTS JSON.</p>
    <br>


    <!-- Hidden File Input -->
    <input type="file" id="fileInput" style="display: none;">

    <!-- Upload Button -->
    <button class="btn btn-outline-primary" type="button" id="uploadButton">Upload Server.ID</button>

    <br>
    <br>
    <p id="status"></p>
    <br>

    <script>
        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("fileInput");
        const uploadButton = document.getElementById("uploadButton");
        const status = document.getElementById("status");

        let selectedFile = null;

        // Open file dialog when clicking dropZone
        dropZone.addEventListener("click", () => fileInput.click());

        // Handle file selection
        fileInput.addEventListener("change", (event) => handleFile(event.target.files[0]));

        async function sha256Hex(file) {
            const buffer = await file.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
            return hashHex;
        }

        // Drag & Drop events
        dropZone.addEventListener("dragover", (event) => {
            event.preventDefault();
            dropZone.classList.add("highlight");
        });

        dropZone.addEventListener("dragleave", () => dropZone.classList.remove("highlight"));

        dropZone.addEventListener("drop", (event) => {
            event.preventDefault();
            dropZone.classList.remove("highlight");
            handleFile(event.dataTransfer.files[0]);
        });

        function handleFile(file) {
            if (!file) return;
            selectedFile = file;
            dropZone.textContent = `Selected: ${file.name}`;
            status.textContent = "";
        }

        uploadButton.addEventListener("click", async () => {
            if (!selectedFile) {
                status.textContent = "No file selected!";
                return;
            }

            status.textContent = "Uploading...";

            const uploadUrl = "/serverid";

            try {
                const localHash = await sha256Hex(selectedFile);
                const response = await fetch(uploadUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": selectedFile.type || "application/octet-stream",
                        "Content-Disposition": `attachment; filename="${selectedFile.name}"`,
                        "Accept": "application/json"
                    },
                    // Send the raw bytes (Blob/File is fine here)
                    body: selectedFile
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }

                const responseJSON = await response.json();
                const serverHash = responseJSON.sha256.toLowerCase();

                if (localHash === serverHash) {		   
                    status.textContent = "Upload successful, hash verifed!";
                } else {
                    status.textContent = "Upload failed!";
                }

                setTimeout(() => {
                    window.location.href = "/domino-ots-setup";
                }, 3000);

            } catch (error) {
                console.error("Upload error:", error);
                status.textContent = `Configuration failed: ${error.message}`;
            }

        });
    </script>

</body>
</html>
